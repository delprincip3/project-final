<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Utente - Ortoplan</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style/output.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOMUhb23mH6JbuHkxE04dNJ7RSI3bRTKIMt/itbZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-green-700 text-white p-4 flex flex-col sm:flex-row justify-between items-center">
        <h1 class="text-3xl mb-4 sm:mb-0">Benvenuto, {{ utente.nome }} {{ utente.cognome }}</h1>
        <nav class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
            <a href="{{ url_for('index') }}" class="text-white hover:underline">Home</a>
            <a href="{{ url_for('login') }}" class="text-white hover:underline">Logout</a>
        </nav>
    </header>

    <!-- Main content -->
    <div class="container mx-auto p-4">

        <!-- Meteo Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-2xl font-bold mb-4">Meteo Attuale</h2>
            <div id="meteo" class="flex items-center space-x-4">
                <i class="fas fa-cloud-sun fa-2x text-yellow-500"></i>
                <div>
                    <p id="weather-description">Caricamento...</p>
                    <p id="temperature"></p>
                </div>
            </div>
        </div>

        <!-- Crea Piantagione Section -->
        <div class="container mb-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4">Crea Piantagione</h2>
                <form method="POST" action="{{ url_for('crea_piantagione') }}">
                    <div class="mb-4">
                        <label for="nome" class="block text-gray-700">Nome Piantagione:</label>
                        <input type="text" name="nome" id="nome" class="block w-full mt-1" required>
                    </div>
                    <div class="mb-4">
                        <label for="descrizione" class="block text-gray-700">Descrizione:</label>
                        <textarea name="descrizione" id="descrizione" class="block w-full mt-1" rows="4" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="data_inizio" class="block text-gray-700">Data Inizio:</label>
                        <input type="date" name="data_inizio" id="data_inizio" class="block w-full mt-1" required>
                    </div>
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Crea Piantagione</button>
                </form>
            </div>
        </div>

        <!-- Associa Pianta Trattamento Button -->
        <div class="mb-6">
            <a href="{{ url_for('associa_pianta_trattamento', user_id=utente.id) }}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Vai alla Pagina di Associazione</a>
        </div>

        <!-- Tabella Piantagioni e Piante Associate -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h2 class="text-2xl font-bold mb-4">Le Tue Piantagioni</h2>
            <table class="table-auto">
                <thead>
                    <tr>
                        <th class="px-4 py-2">Nome Piantagione</th>
                        <th class="px-4 py-2">Descrizione</th>
                        <th class="px-4 py-2">Piante Associate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for piantagione in piantagioni %}
                    <tr>
                        <td class="border px-4 py-2">{{ piantagione.nome }}</td>
                        <td class="border px-4 py-2">{{ piantagione.descrizione }}</td>
                        <td class="border px-4 py-2">
                            <ul>
                                {% for pianta in piantagione.piante %}
                                <li>{{ pianta.nome }}</li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

       <!-- Notifiche Section -->
       <div class="bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold mb-4">Notifiche</h2>
        <ul id="notifications" class="list-disc list-inside">
          {% for notifica in notifiche %}
            <li>
              {{ notifica.trattamento }} - 
              Data inizio: {{ notifica.data_inizio }} - 
              Data fine: {{ notifica.data_fine }}
            </li>
          {% endfor %}
        </ul>
      </div>
      

    <!-- Footer -->
    <footer class="bg-green-600 text-white py-4 px-6 text-center">
        <p class="text-sm">Copyright © <script>document.write(new Date().getFullYear())</script> - All rights reserved by delprincip3</p>
    </footer>
    
    <script>
        const associationForm = document.getElementById('associazioneForm');
      
        // Fetch weather data from API and update DOM
        function fetchWeather() {
          axios.get('/api/weather')
            .then(response => {
              const weatherData = response.data;
              const temperature = weatherData.temperature_2m[0];  // Example of using the first temperature value
              document.getElementById('weather-description').textContent = "Temperatura attuale:";
              document.getElementById('temperature').textContent = `${temperature}°C`;
            })
            .catch(error => {
              console.error('Errore durante il recupero dei dati meteorologici:', error);
            });
        }
      
        // Fetch user plantations data from API and update DOM
        function fetchPiantagioni() {
          axios.get('/api/piantagioni_utente')
            .then(response => {
              const piantagioni = response.data;
              const tableBody = document.querySelector('#piantagioniTable tbody');
              piantagioni.forEach(piantagione => {
                const row = tableBody.insertRow();
                const nomeCell = row.insertCell(0);
                const descrizioneCell = row.insertCell(1);
                const pianteCell = row.insertCell(2);
      
                nomeCell.textContent = piantagione.nome;
                descrizioneCell.textContent = piantagione.descrizione;
                pianteCell.innerHTML = `<ul>${piantagioni.piante.map(pianta => `<li>${pianta}</li>`).join('')}</ul>`;
              });
            })
            .catch(error => {
              console.error('Error fetching user plantations data:', error);
            });
        }
      
        // Fetch trattamenti data from API and update DOM
        function fetchTrattamenti() {
          axios.get('/api/trattamenti_utente')
            .then(response => {
              const trattamenti = response.data;
              const notificationsList = document.getElementById('notifications');
              trattamenti.forEach(trattamento => {
                const listItem = document.createElement('li');
                listItem.textContent = `Trattamento: ${trattamento.trattamento}, Data prevista: ${trattamento.data_prevista}`;
                notificationsList.appendChild(listItem);
              });
            })
            .catch(error => {
              console.error('Error fetching trattamenti data:', error);
            });
        }
      
        // Run setup functions
        fetchWeather();
        fetchPiantagioni();
        fetchTrattamenti();
      
        // Handle form submission for associating plant to plantation
        associationForm.addEventListener('submit', (event) => {
          event.preventDefault(); // Prevent default form submission
      
          const piantagioneId = document.getElementById('piantagione_id').value;
          const piantaId = document.getElementById('pianta_id').value;
          const descrizione = document.getElementById('descrizione').value;
          const dataInizio = document.getElementById('data_inizio').value;
          const dataFine = document.getElementById('data_fine').value;
      
          // Validate input data (optional)
      
          const formData = {
            piantagione_id: piantagioneId,
            pianta_id: piantaId,
            descrizione,
            data_inizio: dataInizio,
            data_fine: dataFine,
          };
      
          axios.post('/api/associa_pianta_piantagione', formData)
            .then(response => {
              if (response.data.success) {
                alert('Associazione avvenuta con successo!');
                // Clear the form
                associationForm.reset();
              } else {
                alert('Errore durante l\'associazione: ' + response.data.error);
              }
            })
            .catch(error => {
              console.error('Error associating plant:', error);
              alert('Errore durante l\'associazione: ' + error.message);
            });
        });
      </script>
      
</body>
</html>

